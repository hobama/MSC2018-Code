#!/bin/bash 
set -eux
set -o pipefail

function yaml2json() {
	remarshal -if yaml -of json $1
}

function process() {
    local malware=$1
    yaml2json "$VT_REPORT_DIR/$malware.yaml" | jq -r '.[].last_analysis_results[] | select( .result != null) | .result' |sort -u > "$DETECTION_OUTPUT_DIR/$malware"
}

MALWARE_DIR='/Users/todor/Code/Masters-Thesis-Code/malware-samples'
VT_REPORT_DIR="$MALWARE_DIR/vt-yaml"
DETECTION_OUTPUT_DIR="$MALWARE_DIR/malware-type"
[ ! -d "$DETECTION_OUTPUT_DIR" ] && mkdir $DETECTION_OUTPUT_DIR
MALWARES=$(find $MALWARE_DIR -d 1 -type f -not -name '.gitignore' | sed 's#.*/##')
for malware in $MALWARES;do
   process $malware
done
